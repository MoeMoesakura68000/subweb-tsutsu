<template>
  <div>
    <el-row style="margin-top: 10px;">
      <el-col>
        <el-card style="margin-top:20px;max-width:800px;margin:auto;opacity:0.8;blackground-color:#0F4677;border-radius: 20px;">
          <div slot="header" style="blackground-color:#0F4677;text-align:center;font-size :25px !important;font-weight: bold !important;">
            <a href="https://theme.sub.tsutsu.cc/"><svg viewBox="0 0 1024 1024" width="25" height="25" style="vertical-align:middle"><path d="M512 65.4c-327 0-448 285.2-448 445.1 0 159.9 116.3 448 438.5 448 0 0 80.1 1.4 80.1-70.6s-36-49-36-100.8c0-51.9 36-74.9 53.3-74.9 17.3 0 131.1 8.6 194.5-15.9C857.7 671.9 960 594.1 960 461.6c0-116.7-121-396.2-448-396.2zM238.9 512c-43 0-77.8-34.8-77.8-77.8s34.8-77.8 77.8-77.8 77.8 34.8 77.8 77.8c-0.1 43-34.9 77.8-77.8 77.8z m146.7-192.5c-43 0-77.8-34.8-77.8-77.8s34.8-77.8 77.8-77.8c42.9 0 77.8 34.8 77.8 77.8s-34.8 77.8-77.8 77.8z m249.5 0c-42.9 0-77.8-34.8-77.8-77.8s34.8-77.8 77.8-77.8c42.9 0 77.8 34.8 77.8 77.8s-34.8 77.8-77.8 77.8zM783.2 512c-42.9 0-77.8-34.8-77.8-77.8s34.8-77.8 77.8-77.8 77.8 34.8 77.8 77.8c0.1 43-34.8 77.8-77.8 77.8z" fill="#ffffff" p-id="1310"></path></svg></a>
                      Nekoha Shizukuの订阅转换                  <a href="https://t.me/MomoeSakura">
<svg
   height="25px"
   id="Layer_1"
   style="enable-background:new 0 0 64 64;"
   version="1.1"
   viewBox="0 0 64 64"
   width="25px"
   xml:space="preserve"
   sodipodi:docname="1242845_social_social media_telegramss_icon.svg"
   inkscape:version="1.1 (c68e22c387, 2021-05-23)"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg"><defs
     id="defs21" /><sodipodi:namedview
     id="namedview19"
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1.0"
     inkscape:pageshadow="2"
     inkscape:pageopacity="0.0"
     inkscape:pagecheckerboard="0"
     showgrid="false"
     inkscape:zoom="7.609375"
     inkscape:cx="32"
     inkscape:cy="32"
     inkscape:window-width="1280"
     inkscape:window-height="738"
     inkscape:window-x="-8"
     inkscape:window-y="-8"
     inkscape:window-maximized="1"
     inkscape:current-layer="Layer_1" /><path
     d="M61.076,16.184C55.586,1.652,34.89-1.19,28.66,0.39c-4.022,1.02-17.318,2-23.865,14.215  C-1.753,26.82-2.703,44.51,9.018,55.04s28.616,12.425,42.238,2.21S66.566,30.715,61.076,16.184z M60.838,36.534  c-0.08,0.236-1.11,2.526-1.11,2.526s-4.91-6.24-5.147-6.24s-0.553,0.95-0.395,1.186c0.158,0.237,5.07,6.24,5.07,6.24l-1.347,2.21  c0,0-4.277-5.765-4.593-5.844c-0.317-0.08-0.95,0.474-0.713,0.71c0.238,0.238,4.752,5.766,4.514,6.24s-1.98,2.053-1.98,2.053  s-3.643-5.37-3.88-5.45c-0.24-0.078-1.11,0.712-0.872,1.186c0.238,0.475,3.8,5.37,3.564,5.687c-0.238,0.316-1.98,2.132-1.98,2.132  s-2.93-4.976-3.247-5.055c-0.316-0.08-1.187,0.948-0.95,1.106c0.24,0.16,3.565,4.74,3.406,5.055c-0.158,0.316-1.98,1.58-1.98,1.58  l-2.93-4.503l-1.11,1.027c0,0,2.614,4.185,2.535,4.58c-0.078,0.395-2.296,1.58-2.296,1.58l-2.613-4.58c0,0-1.108,0.552-1.108,0.79  c0,0.236,2.613,4.738,2.613,4.738l-1.98,0.87c0,0-2.376-4.74-2.613-4.818c-0.238-0.08-1.11-0.158-0.95,0.474  s2.138,4.975,2.138,4.975l-1.98,0.63c0,0-2.138-4.343-2.376-4.5c-0.238-0.16-1.267,0.236-1.11,0.473  c0.16,0.237,2.377,4.74,2.06,4.817s-2.772,0.316-2.772,0.316s-1.82-4.186-2.06-4.265c-0.237-0.078-1.03,0.16-0.95,0.554  c0.08,0.395,1.506,3.87,1.506,3.87H31.06c0,0-1.426-2.922-1.742-3.238c-0.317-0.316-1.346,0.237-1.11,0.474  c0.24,0.237,1.427,2.922,1.19,3c-0.24,0.08-10.138,0.79-18.85-6.633S0.49,33.61,1.678,26.74C2.87,19.87,8.412,8.023,19.024,4.31  c3.735-1.305,10.533-4.58,21.462-1.894S56.958,12.84,57.908,14.42s1.663,4.344,1.663,4.344s-3.642-4.66-4.196-4.74  c-0.554-0.078-0.87,0.79-0.634,1.186c0.238,0.395,4.83,4.896,5.148,5.45c0.317,0.552,0.95,3.87,0.95,3.87s-4.118-5.37-4.593-5.45  c-0.475-0.08-0.792,0.79-0.634,1.027c0.16,0.237,5.386,5.923,5.466,6.24c0.08,0.315,0.475,3.553,0.475,3.553  s-4.988-5.923-5.305-6.002c-0.317-0.08-0.554,1.106-0.554,1.106s5.465,6.002,5.545,6.318c0.08,0.316,0.158,3.396,0.158,3.396  S56.166,28.4,55.77,28.4s-0.475,1.343-0.475,1.343S60.918,36.296,60.838,36.534L60.838,36.534z M14.43,13.708  c2.772-3.713,6.494-5.055,6.494-5.055s-0.475-1.027-0.792-1.106c-0.317-0.08-3.168,0.947-6.652,4.66s-4.375,6.43-4.198,6.87  c0.158,0.395,1.11,0.87,1.584,0.632c0.475-0.237,0.792-2.29,3.564-6.003L14.43,13.708z M43.257,16  c-1.82,0.158-26.61,11.45-29.857,13.426c-3.247,1.974-2.613,4.107-1.822,5.212s8.553,3,8.553,3c0.555,0.396,4.99,9.636,5.703,9.715  c0.713,0.08,5.544-6.555,6.02-6.713c0.474-0.158,2.93,0.87,4.592,1.422c1.663,0.553,5.465,2.21,6.81,1.106  c1.347-1.106,3.644-17.61,4.198-22.192c0.556-4.58-2.375-5.134-4.196-4.976H43.257z M44.762,19.396  c-0.053,0.21-1.426,1.685-1.426,1.685l-0.21-1.368l1.425-1.422c0,0,0.264,0.895,0.212,1.106L44.762,19.396z M12.687,32.11  c0.38-1.434,3.722-2.526,7.365-4.5S42.94,17.42,43.494,17.34s0.158,0.632,0.158,0.632S21.24,36.138,20.845,36.138  C20.449,36.138,11.975,34.796,12.687,32.11L12.687,32.11z M42.544,22.08c-0.106,0.16-1.848,2.107-1.848,2.107s-0.528-2-0.422-2.264  c0,0,1.742-1.58,1.795-1.422c0.052,0.16,0.58,1.423,0.474,1.58L42.544,22.08z M40.01,25.556L38.584,27.4l-1.003-3.213  c0,0,1.638-1.474,1.69-1.316c0.053,0.158,0.74,2.686,0.74,2.686L40.01,25.556z M32.618,28.346c0.158-0.105,1.32-1.316,1.426-1.158  c0.106,0.158,1.584,4.317,1.478,4.528c-0.106,0.21-1.056,1.37-1.056,1.37S32.618,28.346,32.618,28.346z M33.78,34.136l-1.003,1.107  l-2.06-5.265c0.16-0.158,1.004-0.895,1.004-0.895l2.06,5.054L33.78,34.136z M34.94,26.136c0.212-0.16,1.268-1.16,1.268-1.16  l1.32,3.634l-1.162,1.58l-1.425-4.055L34.94,26.136z M25.807,45.616c0,0-3.96-8.32-3.907-8.478l1.848-1.264  c0,0,3.38,8.055,3.273,8.424c-0.104,0.37-1.213,1.317-1.213,1.317L25.807,45.616z M27.972,43.299c0,0-3.326-8.004-3.22-8.32  c0.05-0.15,1.055-1.106,1.213-1.106c0.158,0,3.22,7.845,3.168,8.055S27.973,43.298,27.972,43.299L27.972,43.299z M29.714,40.876  c-0.106-0.21-2.957-7.424-2.798-7.687c0.174-0.29,0.95-0.79,0.95-0.79l2.534,7.424C30.4,39.823,29.82,41.086,29.714,40.876z   M30.824,37.611c0,0-2.113-5.74-1.955-6.107c0.087-0.205,0.844-0.843,1.055-0.843c0.21,0,2.217,5.107,2.165,5.318  c-0.053,0.21-1.267,1.632-1.267,1.632H30.824z M41.594,41.745c-1.11,0.553-9.503-2.685-9.503-3c0-0.317,13.227-18.402,13.702-18.876  C46.073,19.589,42.703,41.192,41.594,41.745L41.594,41.745z"
     id="path16"
     style="fill:#ffffff" /></svg>
</a>
          </div>
          <el-container>
            <el-form :model="form" label-width="80px" label-position="left" style="width: 100%;">
              <el-form-item label="进阶选项:">
                
                  <div class="switch">
                    <input id="cmn-toggle-1" class="cmn-toggle cmn-toggle-round" type="checkbox">
                    <label for="cmn-toggle-1"></label>
                  </div>
                  <div class="switch">
                    <input id="cmn-toggle-4" click = "selectMode()" class="cmn-toggle cmn-toggle-round-flat" type="checkbox">
                    <label for="cmn-toggle-4" ></label>
                  </div>
                  <div class="switch">
                    <input id="cmn-toggle-7" class="cmn-toggle cmn-toggle-yes-no" type="checkbox">
                    <label for="cmn-toggle-7" class="cmn-toggle-label" data-on="1" data-off="2"></label>
                  </div>

                <el-radio v-model="advanced" label="1">基础模式</el-radio>
                <el-radio v-model="advanced" label="2">进阶模式</el-radio>
              </el-form-item>
              <el-form-item label="订阅链接:">
                <el-input
                  v-model="form.sourceSubUrl"
                  type="textarea"
                  rows="3"
                  placeholder="支持订阅或ss/ssr/vmess/trojan链接，多个链接每行一个或用 | 分隔"
                  @blur="saveSubUrl"
                />
              </el-form-item>
              <el-form-item label="生成类型:">
                <el-select v-model="form.clientType" style="width: 100%">
                  <el-option v-for="(v, k) in options.clientTypes" :key="k" :label="k" :value="v"></el-option>
                </el-select>
              </el-form-item>


                <el-form-item label="远程配置:">
                  <el-select
                    v-model="form.remoteConfig"
                    allow-create
                    filterable
                    placeholder="请选择"
                    style="width: 100%"
                  >
                    <el-option-group
                      v-for="group in options.remoteConfig"
                      :key="group.label"
                      :label="group.label"
                    >
                      <el-option
                        v-for="item in group.options"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value"
                      ></el-option>
                    </el-option-group>
                </el-select>
              </el-form-item>

              <el-form-item label="后端地址:">

              <el-select
                  v-model="form.customBackend"
                  allow-create
                  filterable
                  placeholder="请选择"
                  style="width: 100%"
                >
                  <el-option v-for="(v, k) in options.customBackend" :key="k" :label="k" :value="v"></el-option>

                </el-select>

              </el-form-item>

              <div v-if="advanced === '2'">


                <el-form-item label="包含节点:">
                  <el-input v-model="form.includeRemarks" placeholder="节点名包含的关键字，支持正则" />
                </el-form-item>
                <el-form-item label="排除节点:">
                  <el-input v-model="form.excludeRemarks" placeholder="节点名不包含的关键字，支持正则" />
                </el-form-item>
                <el-form-item label="输出名称:">
                  <el-input v-model="form.filename" placeholder="返回的订阅文件名" />
                </el-form-item>
                <el-form-item label-width="0px">
                  <el-row type="flex">
                    <el-col>
                      <el-checkbox v-model="form.nodeList" label="输出为 Node List" border></el-checkbox>
                      <el-checkbox v-model="form.emoji" label="Emoji" border></el-checkbox>
                      <el-checkbox v-model="form.sort" label="排序节点" border></el-checkbox>
                      <el-checkbox v-model="form.udp" @change="needUdp = true" label="启用 UDP" border></el-checkbox>
                      <el-checkbox v-model="form.tpl.surge.doh" label="Surge.DoH" border></el-checkbox>
                      <el-checkbox v-model="form.tpl.clash.doh" label="Clash.DoH" border></el-checkbox>
                    </el-col>
                  </el-row>
                </el-form-item>
              </div>

              <div style="margin-top: 50px"></div>

              <el-divider content-position="center">
                <i class="el-icon-magic-stick"></i>
              </el-divider>

              <el-form-item label="定制订阅:">
                <el-input class="copy-content" disabled v-model="customSubUrl">
                  <el-button
                    slot="append"
                    v-clipboard:copy="customSubUrl"
                    v-clipboard:success="onCopy"
                    ref="copy-btn"
                    icon="el-icon-document-copy"
                  >复制</el-button>
                </el-input>
              </el-form-item>
              <el-form-item label="订阅短链:">
                <el-input class="copy-content" disabled v-model="curtomShortSubUrl">
                  <el-button
                    slot="append"
                    v-clipboard:copy="curtomShortSubUrl"
                    v-clipboard:success="onCopy"
                    ref="copy-btn"
                    icon="el-icon-document-copy"
                  >复制</el-button>
                </el-input>
              </el-form-item>

              
              <el-form-item label-width="0px" style="margin-top: 40px; text-align: center">
                <el-button
                  style="width: 120px"
                  type="primary"
                  @click="makeUrl"
                  :disabled="form.sourceSubUrl.length === 0"
                >生成订阅链接</el-button>
                <el-button
                  style="width: 120px"
                  type="primary"
                  @click="makeShortUrl"
                  :loading="loading"
                  :disabled="customSubUrl.length === 0"
                >生成短链接</el-button>
                <!-- <el-button style="width: 120px" type="primary" @click="surgeInstall" icon="el-icon-connection">一键导入Surge</el-button> -->
              </el-form-item>

              <el-form-item label-width="0px" style="text-align: center">
                <el-button
                  style="width: 120px"
                  type="primary"
                  @click="dialogUploadConfigVisible = true"
                  icon="el-icon-upload"
                  :loading="loading"
                >上传配置</el-button>
                <el-button
                  style="width: 120px"
                  type="primary"
                  @click="clashInstall"
                  icon="el-icon-connection"
                  :disabled="customSubUrl.length === 0"
                >一键导入Clash</el-button>
              </el-form-item>
            </el-form>
          </el-container>
        </el-card>
      </el-col>
    </el-row>

    <el-dialog
      :visible.sync="dialogUploadConfigVisible"
      :show-close="false"
      :close-on-click-modal="false"
      :close-on-press-escape="false"
      width="700px"
    >
      <div slot="title">
        Remote config upload
        <el-popover trigger="hover" placement="right" style="margin-left: 10px">
          <el-link type="primary" :href="sampleConfig" target="_blank" icon="el-icon-info">参考配置</el-link>
          <i class="el-icon-question" slot="reference"></i>
        </el-popover>
      </div>
      <el-form label-position="left">
        <el-form-item prop="uploadConfig">
          <el-input
            v-model="uploadConfig"
            type="textarea"
            :autosize="{ minRows: 15, maxRows: 15}"
            maxlength="10000"
            show-word-limit
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="uploadConfig = ''; dialogUploadConfigVisible = false">取 消</el-button>
        <el-button
          type="primary"
          @click="confirmUploadConfig"
          :disabled="uploadConfig.length === 0"
        >确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
const project = process.env.VUE_APP_PROJECT
const remoteConfigSample = process.env.VUE_APP_SUBCONVERTER_REMOTE_CONFIG
const gayhubRelease = process.env.VUE_APP_BACKEND_RELEASE
const defaultBackend = process.env.VUE_APP_SUBCONVERTER_DEFAULT_BACKEND + '/sub?'
const shortUrlBackend = process.env.VUE_APP_MYURLS_DEFAULT_BACKEND + '/short'
const configUploadBackend = process.env.VUE_APP_CONFIG_UPLOAD_BACKEND + '/config/upload'
const tgBotLink = process.env.VUE_APP_BOT_LINK

export default {
  data() {
    var data = {
      backendVersion: '0.6.4',
      advanced: "1",

      // 是否为 PC 端
      isPC: true,

      options: {
        clientTypes: {
          Clash: "clash",
          ClashR: "clashr",
          Surge2: "surge&ver=2",
          Surge3: "surge&ver=3",
          Surge4: "surge&ver=4",
          Quantumult: "quan",
          "Quantumult X": "quanx",
          Loon: "loon",
          Mellow: "mellow",
          Surfboard: "surfboard",
          "Shadowsocks(SIP002)": "ss",
          "Shadowsocks Android(SIP008)": "sssub",
          ShadowsocksR: "ssr",
          ShadowsocksD: "ssd",          
          V2Ray: "v2ray",
          Trojan: "trojan",
          "混合订阅（mixed）": "mixed",
          "自动判断客户端": "auto",
        },
        customBackend: {
          "AWS永远滴神": "https://sub-back.littleneko.cf/sub?",
          "Heroku yyds": "https://subconventorheroku0192.102983.workers.dev/sub?",
          "Okteto船新版本":"https://subconvertoroktetogensokyo.102983.workers.dev/sub?"
          "Heroku永不掉线": "https://subconventorgensokyo.102983.workers.dev/sub?",
        },
        backendOptions: [
          { value: "https://sub-back.littleneko.cf/sub?" },
          { value: "https://subconventorgensokyo.102983.workers.dev/sub?" },
          { value: "https://subconventorheroku0192.102983.workers.dev/sub?" },
          { value: "https://subconvertoroktetogensokyo.102983.workers.dev/sub?"},
        ],
        remoteConfig: [
          {
            label: "Telegram: @Ox208",
            options: [
              {
                label: "つつ自用-完整分组",
                value:
                  "https://cdn.staticaly.com/gh/lhl77/sub-ini/main/tsutsu-full.ini"
              },
              {
                label: "つつ自用-完整分组(地区自动选择)",
                value:
                  "https://cdn.staticaly.com/gh/lhl77/sub-ini/main/tsutsu-full-urltest.ini"
              },
              {
                label: "つつ自用-Immtel专用(地区自动选择)",
                value:
                  "https://cdn.staticaly.com/gh/lhl77/sub-ini/main/tsutsu-full-urltest-imm.ini"
              },
              {
                label: "つつ自用-超精简分组(含国内分流)",
                value:
                  "https://cdn.staticaly.com/gh/lhl77/sub-ini/main/tsutsu-mini-gfw.ini"
              },
            ]
          },
          {
            label: "Telegram Chat @tsutsu_group",
            options: [
              {
                label: "hope140自用配置 (与Github同步)",
                value:
                  "https://cdn.staticaly.com/gh/hope140/Clash/beta/hope140.yaml"
              },
              {
                label: "hope140去广告配置",
                value:
                  "https://cdn.staticaly.com/gh/hope140/Clash/beta/Adblock.yaml"
              },
              {
                label: "hope140全分组",
                value:
                  "https://cdn.staticaly.com/gh/hope140/Clash/beta/All.yaml"
              },
              {
                label: "Nine499自用规则",
                value:
                  "https://cdn.staticaly.com/gh/Nine499/Clash-Rule/master/Rule"
              },
              {
                label: "AllenXu精简版多国家",
                value:
                  "https://gitproxy.102983.workers.dev/hyt-allen-xu/webcdn/master/cdn_multicountry.ini"
              },
              {
                label: "AllenXu小机场专用",
                value:
                  "https://gitproxy.102983.workers.dev/hyt-allen-xu/webcdn/master/smallairport.ini"
              },
            ]
          },
          {
            label: "Github: @ACL4SSR",
            options: [
              {
                label: "ACL4SSR默认",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini"
              },
              {
                label: "ACL4SSR去广告",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_AdblockPlus.ini"
              },
              {
                label: "ACL4SSR无自动测速",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_NoAuto.ini"
              },
              {
                label: "ACL4SSR无广告拦截",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_NoReject.ini"
              },
              {
                label: "ACL4SSR精简版",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini.ini"
              },
              {
                label: "ACL4SSR精简去广告",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_AdblockPlus.ini"
              },
              {
                label: "ACL4SSR精简多重模式",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Mini_MultiMode.ini"
              },
              {
                label: "ACL4SSR精简版带港美日国家",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiCountry.ini"
              },
              {
                label: "ACL4SSR全分组",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini"
              },
              {
                label: "ACL4SSR全分组多模式",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_MultiMode.ini"
              },
              {
                label: "ACL4SSR全分组重度用户",
                value:
                  "https://cdn.staticaly.com/gh/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_Netflix.ini"
              }
            ]
          },
          {
            label: "特殊",
            options: [
              {
                label: "什么都没有",
                value:
                  "https://subconverter.oss-ap-southeast-1.aliyuncs.com/Rules/RemoteConfig/special/basic.ini"
              },
              {
                label: "Creeper?",
                value:
                  "https://gitproxy.102983.workers.dev/greatFireWallTechnology/Subweb-Gitpages/main/creeper.ini"
              }
            ]
          }
        ]
      },
      form: {
        sourceSubUrl: "",
        clientType: "",
        customBackend: "",
        remoteConfig: "",
        excludeRemarks: "",
        includeRemarks: "",
        filename: "",
        emoji: true,
        nodeList: false,
        extraset: false,
        sort: false,
        udp: false,
        tfo: false,
        scv: false,
        expand: true, // 是否将规则全文写进配置文件
        fdn: false,
        appendType: false,
        insert: false, // 是否插入默认订阅的节点，对应配置项 insert_url
        new_name: true, // 是否使用 Clash 新字段
        // tpl 定制功能
        tpl: {
          surge: {
            doh: false // dns 查询是否使用 DoH
          },
          clash: {
            doh: false
          }
        }
      },

      loading: false,
      customSubUrl: "",
      curtomShortSubUrl: "",

      dialogUploadConfigVisible: false,
      uploadConfig: "",
      uploadPassword: "",
      myBot: tgBotLink,
      sampleConfig: remoteConfigSample,

      needUdp: false, // 是否需要添加 udp 参数
    };

    // window.console.log(data.options.remoteConfig);
    // window.console.log(data.options.customBackend);
    let phoneUserAgent = /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
      navigator.userAgent
    );

    if (phoneUserAgent) {
      let acl4ssrConfig = data.options.remoteConfig[1].options;
      for (let i = 0; i < acl4ssrConfig.length; i++) {
        if (acl4ssrConfig[i].label.length > 10) {
          acl4ssrConfig[i].label = acl4ssrConfig[i].label.replace(/\s.*/, "");
        }
      }
      var serverList = {};
      let serverKeys = Object.keys(data.options.customBackend);
      for (let i = 0; i < serverKeys.length; i++) {
        let key = serverKeys[i].replace(/\(.*/, "");
        serverList[key] = data.options.customBackend[serverKeys[i]];
      }
      data.options.customBackend = serverList;
    }
    return data;
  },
  created() {
    // document.title = "Subscription Converter";
    document.title = "Nekoha Shizukuの船新订阅转换 ";
     this.isPC = this.$getOS().isPc;

    // 获取 url cache
    if (process.env.VUE_APP_USE_STORAGE === 'true') {
      this.form.sourceSubUrl = this.getLocalStorageItem('sourceSubUrl')
    }
  },
  mounted() {
    this.form.clientType = "clash";
    this.form.customBackend = "https://subconventorgensokyo.102983.workers.dev/sub?";
    this.form.remoteConfig = "https://cdn.staticaly.com/gh/lhl77/sub-ini/main/tsutsu-full.ini";
    //this.getBackendVersion();
  },
  methods: {
    onCopy() {
      this.$message.success("Copied!");
    },
    goToProject() {
      window.open(project);
    },
    gotoGayhub() {
      window.open(gayhubRelease);
    },
    gotoRemoteConfig() {
      window.open(remoteConfigSample);
    },
    clashInstall() {
      if (this.customSubUrl === "") {
        this.$message.error("请先填写必填项，生成订阅链接");
        return false;
      }

      const url = "clash://install-config?url=";
      window.open(
        url +
          encodeURIComponent(
            this.curtomShortSubUrl !== ""
              ? this.curtomShortSubUrl
              : this.customSubUrl
          )
      );
    },
    surgeInstall() {
      if (this.customSubUrl === "") {
        this.$message.error("请先填写必填项，生成订阅链接");
        return false;
      }

      const url = "surge://install-config?url=";
      window.open(url + this.customSubUrl);
    },
    makeUrl() {
      if (this.form.sourceSubUrl === "" || this.form.clientType === "") {
        this.$message.error("订阅链接与客户端为必填项");
        return false;
      }
      // 远程接口
      let backend =
        this.form.customBackend === ""
          ? defaultBackend
          : this.form.customBackend;

      // 远程配置
      let config = this.form.remoteConfig === "" ? "" : this.form.remoteConfig;

      let sourceSub = this.form.sourceSubUrl;
      sourceSub = sourceSub.replace(/(\n|\r|\n\r)/g, "|");

      // 薯条屏蔽
      if (sourceSub.indexOf("losadhwse") !== -1 && (backend.indexOf("py6.pw") !== -1 || backend.indexOf("subconverter-web.now.sh") !== -1 || backend.indexOf("subconverter.herokuapp.com") !== -1 || backend.indexOf("api.wcc.best") !== -1)) {
        this.$alert('此机场订阅已将该后端屏蔽，请自建Subconventor转换。', '转换错误提示', {
          confirmButtonText: '确定',
          callback: action => {
            this.$message({
              type: 'error',
              message: `action: ${ action }`
            });
          }
        });
        return false;
      }

      this.customSubUrl =
        backend +
        "target=" +
        this.form.clientType +
        "&url=" +
        encodeURIComponent(sourceSub) +
        "&insert=" +
        this.form.insert;

      if (config !== "") {
        this.customSubUrl += "&config=" + encodeURIComponent(config);
      }

      if (this.advanced === "2") {
        if (this.form.excludeRemarks !== "") {
          this.customSubUrl +=
            "&exclude=" + encodeURIComponent(this.form.excludeRemarks);
        }
        if (this.form.includeRemarks !== "") {
          this.customSubUrl +=
            "&include=" + encodeURIComponent(this.form.includeRemarks);
        }
        if (this.form.filename !== "") {
          this.customSubUrl +=
            "&filename=" + encodeURIComponent(this.form.filename);
        }
        if (this.form.appendType) {
          this.customSubUrl +=
            "&append_type=" + this.form.appendType.toString();
        }

        this.customSubUrl +=
          "&emoji=" +
          this.form.emoji.toString() +
          "&list=" +
          this.form.nodeList.toString() +
          "&tfo=" +
          this.form.tfo.toString() +
          "&scv=" +
          this.form.scv.toString() +
          "&fdn=" +
          this.form.fdn.toString() +
          "&sort=" +
          this.form.sort.toString() +
          "&expand=" +
          this.form.expand.toString();

        if (this.needUdp) {
          this.customSubUrl += "&udp=" + this.form.udp.toString()
        }
        if (this.form.tpl.surge.doh === true) {
          this.customSubUrl += "&surge.doh=true";
        }
        if (this.form.clientType === "clash") {
          if (this.form.tpl.clash.doh === true) {
            this.customSubUrl += "&clash.doh=true";
          }
          this.customSubUrl += "&new_name=" + this.form.new_name.toString();
        }
      }
      this.$copyText(this.customSubUrl);
      this.$message.success("定制订阅已复制到剪贴板");
    },
    makeShortUrl() {
      if (this.customSubUrl === "") {
        this.$message.warning("请先生成订阅链接，再获取对应短链接");
        return false;
      }

      this.loading = true;

      let data = new FormData();
      data.append("longUrl", btoa(this.customSubUrl));

      this.$axios
        .post(shortUrlBackend, data, {
          header: {
            "Content-Type": "application/form-data; charset=utf-8"
          }
        })
        .then(res => {
          if (res.data.Code === 1 && res.data.ShortUrl !== "") {
            this.curtomShortSubUrl = res.data.ShortUrl;
            this.$copyText(res.data.ShortUrl);
            this.$message.success("短链接已复制到剪贴板");
          } else {
            this.$message.error("短链接获取失败：" + res.data.Message);
          }
        })
        .catch(() => {
          this.$message.error("短链接获取失败");
        })
        .finally(() => {
          this.loading = false;
        });
    },
    confirmUploadConfig() {
      if (this.uploadConfig === "") {
        this.$message.warning("远程配置不能为空");
        return false;
      }

      this.loading = true;

      let data = new FormData();
      data.append("password", this.uploadPassword);
      data.append("config", this.uploadConfig);

      this.$axios
        .post(configUploadBackend, data, {
          header: {
            "Content-Type": "application/form-data; charset=utf-8"
          }
        })
        .then(res => {
          if (res.data.Code === 1 && res.data.url !== "") {
            this.$message.success(
              "远程配置上传成功，配置链接已复制到剪贴板，有效期三个月望知悉"
            );

            // 自动填充至『表单-远程配置』
            this.form.remoteConfig = res.data.Url;
            this.$copyText(this.form.remoteConfig);

            this.dialogUploadConfigVisible = false;
          } else {
            this.$message.error("远程配置上传失败：" + res.data.Message);
          }
        })
        .catch(() => {
          this.$message.error("远程配置上传失败");
        })
        .finally(() => {
          this.loading = false;
        });
    },
    backendSearch(queryString, cb) {
      let backends = this.options.backendOptions;

      let results = queryString
        ? backends.filter(this.createFilter(queryString))
        : backends;

      // 调用 callback 返回建议列表的数据
      cb(results);
    },
    createFilter(queryString) {
      return candidate => {
        return (
          candidate.value.toLowerCase().indexOf(queryString.toLowerCase()) === 0
        );
      };
    },
    getBackendVersion() {
      this.$axios
        .get(
          defaultBackend.substring(0, defaultBackend.length - 5) + "/version"
        )
        .then(res => {
          this.backendVersion = res.data.replace(/backend\n$/gm, "");
          this.backendVersion = this.backendVersion.replace("subconverter", "");
        });
    },
    saveSubUrl() {
      if (this.form.sourceSubUrl !== '') {
        this.setLocalStorageItem('sourceSubUrl', this.form.sourceSubUrl)
      }
    },
    getLocalStorageItem(itemKey) {
      const now = +new Date()
      let ls = localStorage.getItem(itemKey)

      let itemValue = ''
      if (ls !== null) {
        let data = JSON.parse(ls)
        if (data.expire > now) {
          itemValue = data.value
        } else {
          localStorage.removeItem(itemKey)
        }
      }

      return itemValue
    },
    setLocalStorageItem(itemKey, itemValue) {
      const ttl = process.env.VUE_APP_CACHE_TTL
      const now = +new Date()

      let data = {
        setTime: now,
        ttl: parseInt(ttl),
        expire: now + ttl * 1000,
        value: itemValue
      }
      localStorage.setItem(itemKey, JSON.stringify(data))
    }
  },

};

</script>
